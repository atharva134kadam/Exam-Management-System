<!DOCTYPE html>
<html lang="en">
<head>
  <title>EduSmart 360 | Student Portal</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs, query, where, setDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyClbcYYVjl6mnEdxMUyC-YC4jDztOlOGZA",
  authDomain: "admin-management-db779.firebaseapp.com",
  projectId: "admin-management-db779",
  storageBucket: "admin-management-db779.firebasestorage.app",
  messagingSenderId: "144412069580",
  appId: "1:144412069580:web:52670196ee40c687ddbc69",
  measurementId: "G-HY31FECMSB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let studentData = null;
let cheatWarnings = 0;
const MAX_WARNINGS = 3;

/* ================= AUTH & INITIALIZATION ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "login.html";
  const studentDoc = await getDoc(doc(db, "users", user.uid));
  if (!studentDoc.exists() || studentDoc.data().role !== "student") return window.location.href = "login.html";
  studentData = studentDoc.data();
  updateUI();
  await loadDashboardData();
  lucide.createIcons();
});

function updateUI() {
  document.querySelectorAll(".u-name").forEach(el => el.innerText = studentData.name);
  document.getElementById("u-dept-sub").innerText = studentData.department + " • Batch " + studentData.batch;
  document.getElementById("u-initials").innerText = studentData.name.split(' ').map(n => n[0]).join('').toUpperCase();
  document.getElementById("port-name").innerText = studentData.name;
  document.getElementById("port-dept").innerText = studentData.department;
  document.getElementById("info-name-v").innerText = studentData.name;
  document.getElementById("info-prn").innerText = studentData.prn;
  document.getElementById("info-dept").innerText = studentData.department;
  document.getElementById("info-batch").innerText = studentData.batch;
  document.getElementById("info-email").innerText = studentData.email;
  document.getElementById("info-phone").innerText = studentData.phone || "N/A";
}

async function loadDashboardData() {
    const respQuery = query(collection(db, "responses"), where("studentId", "==", auth.currentUser.uid));
    const respSnap = await getDocs(respQuery);
    const takenIds = respSnap.docs.map(d => d.data().examId);
    await Promise.all([loadExams(takenIds), loadResults(respSnap), loadGrievanceOptions(respSnap), loadExistingGrievances()]);
}

/* ================= NAVIGATION ================= */
window.showSection = function(id) {
  document.querySelectorAll(".section-content").forEach(sec => sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".tab-item").forEach(tab => tab.classList.remove("active-tab"));
  if(event) event.currentTarget.classList.add("active-tab");
  lucide.createIcons();
};

/* ================= EXAMS & BENCH ================= */
async function loadExams(takenIds) {
  const onlineContainer = document.getElementById("onlineExams");
  const offlineTableBody = document.getElementById("offlineTableBody");
  const q = query(collection(db, "exams"), where("department", "==", studentData.department));
  const examSnap = await getDocs(q);
  const slotQ = query(collection(db, "exam_slots"), where("studentId", "==", auth.currentUser.uid));
  const slotSnap = await getDocs(slotQ);
  const mySeating = {};
  slotSnap.forEach(s => mySeating[s.data().examId] = s.data());
  const availableExams = examSnap.docs.filter(doc => !takenIds.includes(doc.id));
  onlineContainer.innerHTML = ""; offlineTableBody.innerHTML = "";
  let hasOffline = false;
  availableExams.forEach(docSnap => {
    const exam = docSnap.data();
    if (exam.type === 'mcq' || exam.type === 'online') {
      onlineContainer.innerHTML += `<div class="card list-item animate-in"><div class="item-info"><div class="icon-bg blue-icon"><i data-lucide="monitor"></i></div><div><h4 class="m-0">${exam.title}</h4><small>${exam.totalMarks} Marks • ${exam.date}</small></div></div><button class="action-btn" onclick="takeExam('${docSnap.id}')">Start Test</button></div>`;
    } else {
      hasOffline = true;
      const seat = mySeating[docSnap.id];
      const seatingView = seat ? `<div class="bench-tag"><b>${seat.classroom}</b> • Bench #${seat.benchNumber}</div>` : `<span class="badge-pending">Pending</span>`;
      offlineTableBody.innerHTML += `<tr><td><div class="icon-bg-sm orange-icon"><i data-lucide="calendar"></i></div></td><td><b>${exam.title}</b></td><td>${exam.date}</td><td>${exam.time}</td><td>${seatingView}</td></tr>`;
    }
  });
  document.getElementById("offlineCard").style.display = hasOffline ? "block" : "none";
}

/* ================= SHARED UTILS ================= */
async function loadResults(respSnap) {
    const container = document.getElementById("resultsContainer");
    container.innerHTML = respSnap.empty ? "<p class='text-muted'>No results published.</p>" : "";
    for (const d of respSnap.docs) {
        const res = d.data();
        const examDoc = await getDoc(doc(db, "exams", res.examId));
        container.innerHTML += `<div class="card list-item"><div><h4 class="m-0">${examDoc.exists() ? examDoc.data().title : 'Exam'}</h4><small class="text-accent font-bold">Score: ${res.autoScore}</small></div><button class="btn-outline" onclick="showSection('grievance')">Grievance</button></div>`;
    }
    lucide.createIcons();
}

async function loadGrievanceOptions(respSnap) {
    const select = document.getElementById("grievanceExamSelect");
    select.innerHTML = '<option value="">Select Completed Exam</option>';
    for (const d of respSnap.docs) {
        const res = d.data();
        const examDoc = await getDoc(doc(db, "exams", res.examId));
        select.innerHTML += `<option value="${res.examId}">${examDoc.exists() ? examDoc.data().title : 'Archived'}</option>`;
    }
}

window.submitGrievance = async function() {
    if(!grievanceExamSelect.value) return alert("Select an exam.");
    await addDoc(collection(db, "grievances"), { studentId: auth.currentUser.uid, studentName: studentData.name, dept: studentData.department, examId: grievanceExamSelect.value, reason: grievanceReason.value, details: grievanceDetails.value, status: "Open", createdAt: serverTimestamp() });
    alert("Support ticket raised."); location.reload();
};

/* ================= UPDATED GRIEVANCE HISTORY (FEEDS FROM COMMENTS) ================= */
async function loadExistingGrievances() {
    const container = document.getElementById("grievanceHistory");
    const q = query(collection(db, "grievances"), where("studentId", "==", auth.currentUser.uid));
    const snap = await getDocs(q);
    
    container.innerHTML = "";
    
    for (const d of snap.docs) {
        const g = d.data();
        const gid = d.id;
        
        // Fetch Faculty Comment if Resolved
        let facultyCommentHTML = "";
        if (g.status === "Resolved") {
            const cq = query(collection(db, "comments_grievances"), where("grievanceId", "==", gid));
            const cSnap = await getDocs(cq);
            if (!cSnap.empty) {
                const cData = cSnap.docs[0].data();
                facultyCommentHTML = `
                    <div class="faculty-response">
                        <div class="flex-between">
                            <small class="font-bold text-accent"><i data-lucide="message-square" size="12"></i> Faculty Feedback</small>
                            <small class="text-muted">${cData.facultyName}</small>
                        </div>
                        <p class="m-0 mt-5" style="font-size:13px; font-style: italic;">"${cData.comment}"</p>
                    </div>`;
            }
        }

        container.innerHTML += `
            <div class="card mb-10">
                <div class="flex-between">
                    <div>
                        <b style="font-size:15px;">${g.reason}</b>
                        <p class="m-0 text-muted" style="font-size:12px;">Ref: ${gid.substring(0,8)}</p>
                    </div>
                    <span class="status-badge ${g.status.toLowerCase()}">${g.status}</span>
                </div>
                <p class="mt-10 mb-10" style="font-size:14px; border-left: 3px solid var(--border); padding-left: 10px;">${g.details}</p>
                ${facultyCommentHTML}
            </div>`;
    }
    lucide.createIcons();
}

window.takeExam = async function(eid) {
    const docSnap = await getDoc(doc(db, "exams", eid));
    const exam = docSnap.data(); cheatWarnings = 0; setupAntiCheat(eid);
    examPortal.classList.add("portal-active");
    examPortal.innerHTML = `<div class="p-head"><h2>${exam.title}</h2><div id="w-count" class="w-pill">Warnings: 0/3</div></div><div class="p-body">
    ${exam.questions.map((q, i) => `<div class="card mb-20"><b>Q${i+1}.</b> ${q.text}<br>${q.type==='mcq' ? q.options.map((o, idx) => `<label class="opt-label"><input type="radio" name="q_${q.id}" value="${idx}"> ${o}</label>`).join('') : `<textarea name="q_${q.id}"></textarea>`}</div>`).join('')}
    <button class="submit-btn" onclick="submitResponses('${eid}')">Submit Examination</button></div>`;
};

function setupAntiCheat(eid) {
    document.onvisibilitychange = () => { if (document.hidden) { cheatWarnings++; if(document.getElementById('w-count')) document.getElementById('w-count').innerText = `Warnings: ${cheatWarnings}/3`; if (cheatWarnings >= MAX_WARNINGS) submitResponses(eid, true); } };
}

window.submitResponses = async function(eid, forced = false) {
    const examSnap = await getDoc(doc(db, "exams", eid));
    const exam = examSnap.data();
    let responses = {}, score = 0;
    exam.questions.forEach(q => {
        const input = q.type === 'mcq' ? document.querySelector(`input[name="q_${q.id}"]:checked`) : document.querySelector(`textarea[name="q_${q.id}"]`);
        if (input) { responses[q.id] = input.value; if (q.type === 'mcq' && input.value == q.correctAnswer) score += Number(q.marks); }
    });
    await setDoc(doc(db, "responses", `${eid}_${auth.currentUser.uid}`), { examId: eid, studentId: auth.currentUser.uid, studentName: studentData.name, responses, autoScore: score, isForced: forced, warnings: cheatWarnings, submittedAt: serverTimestamp() });
    location.reload();
};

window.logoutUser = () => signOut(auth).then(() => window.location.href = "login.html");
</script>

<style>
:root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --white: #ffffff; --border: #e2e8f0; --text: #1e293b; --muted: #64748b; --orange: #f59e0b; --red: #ef4444; }
body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

/* Premium Header */
.navbar { background: var(--primary); color: white; padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
.welcome-card { background: var(--primary); color: white; padding: 40px 5% 80px 5%; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; }
.stats-box { display: flex; gap: 15px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }

/* Navigation Tabs */
.tabs-container { max-width: 1000px; margin: -40px auto 30px auto; background: var(--white); border-radius: 100px; display: flex; padding: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow-x: auto; scrollbar-width: none; border: 1px solid var(--border); }
.tab-item { flex: 1; padding: 14px 24px; border-radius: 100px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--muted); transition: 0.3s; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 10px; }
.active-tab { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }

/* Cards & Grid */
.main-content { max-width: 1000px; margin: 0 auto 50px auto; padding: 0 15px; }
.section-content { display: none; }
.section-content.active { display: block; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
.card { background: var(--white); border-radius: 24px; padding: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid var(--border); }

/* Faculty Response Style */
.faculty-response { background: #f0f7ff; border: 1px dashed var(--accent); border-radius: 16px; padding: 15px; margin-top: 15px; }

/* Status Badges */
.status-badge { font-size: 10px; padding: 5px 12px; border-radius: 100px; font-weight: 800; text-transform: uppercase; }
.status-badge.open { background: #fff7ed; color: var(--orange); }
.status-badge.resolved { background: #dcfce7; color: #166534; }

/* Bench & Seating UI */
.bench-tag { background: #eff6ff; color: var(--accent); padding: 10px 14px; border-radius: 14px; font-size: 13px; border-left: 5px solid var(--accent); font-weight: 700; }
.badge-pending { background: #fff7ed; color: var(--orange); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; }

/* Portfolio Styles */
.port-hero { text-align: center; padding: 20px 0 30px 0; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
.p-avatar { width: 90px; height: 90px; background: var(--accent); color: white; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 800; margin: 0 auto 15px auto; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; }
.info-group label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); font-weight: 800; margin-bottom: 6px; }
.info-group p { font-weight: 700; margin: 0; font-size: 15px; color: var(--primary); }

/* Table Styles */
.tt-table { width: 100%; border-collapse: collapse; }
.tt-table th { text-align: left; padding: 15px; color: var(--muted); font-size: 11px; text-transform: uppercase; font-weight: 800; border-bottom: 2px solid var(--bg); }
.tt-table td { padding: 18px 15px; border-bottom: 1px solid var(--bg); font-size: 14px; }

/* List Items */
.list-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-radius: 20px; transition: 0.3s; }
.icon-bg { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.blue-icon { background: #eff6ff; color: var(--accent); }
.orange-icon { background: #fff7ed; color: var(--orange); }

/* Buttons & Inputs */
.action-btn { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
.btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 10px; font-weight: 700; cursor: pointer; }
select, textarea { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--border); background: #fcfdfe; font-size: 14px; box-sizing: border-box; }

/* Exam Portal Overlay */
.exam-portal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); z-index: 2000; display: none; overflow-y: auto; }
.portal-active { display: block; animation: slideUp 0.4s ease; }
.p-head { background: var(--primary); color: white; padding: 20px 10%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
.opt-label { display: block; padding: 16px; background: #f8fafc; border: 1px solid var(--border); border-radius: 15px; margin-top: 15px; cursor: pointer; transition: 0.2s; font-weight: 600; }
.submit-btn { background: #10b981; color: white; border: none; padding: 20px; border-radius: 15px; font-size: 18px; font-weight: 800; width: 100%; cursor: pointer; margin: 50px 0; }

.flex-between { display: flex; justify-content: space-between; align-items: center; }
.text-accent { color: var(--accent); } .font-bold { font-weight: 800; } .m-0 { margin: 0; } .mt-5 { margin-top: 5px; } .mt-10 { margin-top: 10px; } .mb-10 { margin-bottom: 10px; } .w-100 { width: 100%; }

@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<nav class="navbar">
  <div style="font-weight: 800; font-size: 22px; letter-spacing: -0.5px;">EduSmart <span class="text-accent">360</span></div>
  <div style="display:flex; align-items:center; gap:20px;">
    <div style="text-align:right" class="hide-mobile">
        <div class="u-name font-bold" style="font-size:14px;">--</div>
        <small id="u-dept-sub" style="color:rgba(255,255,255,0.6); font-size:10px;">--</small>
    </div>
    <button onclick="logoutUser()" style="background:var(--red); color:white; border:none; padding:8px 16px; border-radius:12px; font-size:12px; font-weight:700; cursor:pointer;">Logout</button>
  </div>
</nav>

<header class="welcome-card">
  <div>
      <h1 class="m-0" style="font-size: clamp(24px, 5vw, 36px);">Student Workspace</h1>
      <p style="color:rgba(255,255,255,0.5); margin-top:10px; font-weight:500;">Academic Portfolio & Proctored Assessments</p>
  </div>
  <div class="stats-box">
    <div style="text-align:center; min-width:70px;"><h3>9.2</h3><small>CGPA</small></div>
    <div style="text-align:center; border-left:1px solid rgba(255,255,255,0.1); padding-left:15px; min-width:70px;"><h3>12</h3><small>RANK</small></div>
  </div>
</header>

<div class="tabs-container">
  <button class="tab-item active-tab" onclick="showSection('portfolio')"><i data-lucide="user-circle"></i> Portfolio</button>
  <button class="tab-item" onclick="showSection('exams')"><i data-lucide="calendar"></i> Examinations</button>
  <button class="tab-item" onclick="showSection('results')"><i data-lucide="award"></i> Results</button>
  <button class="tab-item" onclick="showSection('grievance')"><i data-lucide="help-circle"></i> Help Desk</button>
</div>

<div class="main-content">
  <div id="portfolio" class="section-content active">
    <div class="card">
        <div class="port-hero">
            <div id="u-initials" class="p-avatar">--</div>
            <h2 id="port-name" class="m-0" style="font-size:28px; letter-spacing:-0.5px;">--</h2>
            <p id="port-dept" style="color:var(--accent); font-weight:700; margin-top:5px; text-transform:uppercase; font-size:12px;">--</p>
        </div>
        <div class="info-grid">
          <div class="info-group"><label>Identity</label><p id="info-name-v">--</p></div>
          <div class="info-group"><label>PRN Number</label><p id="info-prn">--</p></div>
          <div class="info-group"><label>Department</label><p id="info-dept">--</p></div>
          <div class="info-group"><label>Admission Batch</label><p id="info-batch">--</p></div>
          <div class="info-group"><label>Email Address</label><p id="info-email">--</p></div>
          <div class="info-group"><label>Verified Phone</label><p id="info-phone">--</p></div>
        </div>
    </div>
  </div>

  <div id="exams" class="section-content">
    <div class="card">
      <h3 style="margin:0 0 20px 0; display:flex; align-items:center; gap:10px;"><i data-lucide="monitor" class="text-accent"></i> Online Proctored Assessments</h3>
      <div id="onlineExams"></div>
    </div>
    
    <div class="card" id="offlineCard">
      <h3 style="margin:0 0 20px 0; display:flex; align-items:center; gap:10px;"><i data-lucide="layout" class="text-accent"></i> Time Table & Allotted Bench</h3>
      <div style="overflow-x:auto;">
          <table class="tt-table">
            <thead><tr><th></th><th>Exam Subject</th><th>Date</th><th>Time</th><th>Bench Allocation</th></tr></thead>
            <tbody id="offlineTableBody"></tbody>
          </table>
      </div>
    </div>
  </div>

  <div id="results" class="section-content">
    <div class="card">
        <h3 style="margin:0 0 20px 0;">Performance Audit</h3>
        <div id="resultsContainer"></div>
    </div>
  </div>

  <div id="grievance" class="section-content">
    <div class="card">
      <h3 style="margin:0;">Dispute Resolution</h3>
      <p style="color:var(--muted); font-size:13px; margin:10px 0 25px 0;">File a formal grievance for grade discrepancies or seating errors.</p>
      <select id="grievanceExamSelect" style="margin-bottom:15px;"></select>
      <select id="grievanceReason" style="margin-bottom:15px;">
          <option value="Marks Mismatch">Marks Mismatch</option>
          <option value="Seating Issue">Seating Allocation Error</option>
          <option value="Proctoring Dispute">Technical Proctoring Dispute</option>
      </select>
      <textarea id="grievanceDetails" rows="4" placeholder="Describe your concern with evidence..."></textarea>
      <button class="action-btn w-100" style="margin-top:25px;" onclick="submitGrievance()">Submit Dispute Ticket</button>
    </div>
    <h4 style="margin:30px 0 15px 0; color:var(--muted)">Submission History</h4>
    <div id="grievanceHistory"></div>
  </div>
</div>

<div id="examPortal" class="exam-portal"></div>
<script>lucide.createIcons();</script>
</body>
</html>